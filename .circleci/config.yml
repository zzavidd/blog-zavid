version: 2.1

executors:
  node:
    docker:
      - image: cimg/node:16.3.0
  ssh:
    docker:
      - image: arvindr226/alpine-ssh

commands:
  install_dependencies:
    description: "Installs all project dependencies."
    steps:
      - checkout
      - restore_cache:
          name: Restore yarn cache
          keys:
            - yarn-packages-{{ .Environment.CACHE_VERSION }}-{{ checksum "./code/yarn.lock" }}
      - run:
          name: Install dependencies
          command: yarn install
          working_directory: ./code
      - save_cache:
          name: Save yarn cache
          key: yarn-packages-{{ .Environment.CACHE_VERSION }}-{{ checksum "./code/yarn.lock" }}
          paths:
            - code/.yarn/cache
            - code/.yarn/unplugged
  transfer_scripts:
    description: "Transfers deployment scripts via SCP"
    parameters:
      mode:
        type: string
    steps:
      - checkout
      - run:
          name: Transfer scripts
          command: scp -o StrictHostKeyChecking=no -r ./devops/scripts/* $SSH_USER@$SSH_ADDRESS:/home/circleci/scripts/
          no_output_timeout: 30s
      - run:
          name: Run << parameters.mode >> deployment
          command: |
            ssh -o StrictHostKeyChecking=no -v $SSH_USER@$SSH_ADDRESS "./scripts/deploy.<< parameters.mode >>.sh"

jobs:
  inspect:
    executor: node
    steps:
      - install_dependencies
      - run:
          name: Run TypeScript checks
          command: yarn run tsc
          working_directory: ./code
      - run:
          name: Run ESLint
          command: yarn run eslint --max-warnings 0
          working_directory: ./code
      - run:
          name: Run Prettier checks
          command: yarn run prettier:check
          working_directory: ./code
  build:
    executor: node
    steps:
      - install_dependencies
      - restore_cache:
          name: Restore build cache
          keys:
            - next-build-{{ .Environment.CACHE_VERSION }}-{{ checksum "./code/yarn.lock" }}
      - run:
          name: Build project
          command: yarn run build
          working_directory: ./code
      - save_cache:
          key: next-build-{{ .Environment.CACHE_VERSION }}-{{ checksum "./code/yarn.lock" }}
          paths:
            - code/.next/cache
  deploy_staging:
    executor: ssh
    steps:
      - transfer_scripts:
          mode: staging
  deploy_prod:
    executor: ssh
    steps:
      - transfer_scripts:
          mode: production

workflows:
  inspect_test_deploy:
    jobs:
      - inspect:
          filters:
            branches:
              ignore:
                - production
      - build:
          filters:
            branches:
              ignore:
                - production
      - deploy_staging:
          requires:
            - inspect
            - build
          filters:
            branches:
              only:
                - main
      - deploy_prod:
          filters:
            branches:
              only:
                - production
